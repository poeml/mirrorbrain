
<IfModule mod_zrkadlo.c>

    # enable / disable memcache usage
    ZrkadloMemcached On
    # configure memcache daemon(s)
    ZrkadloMemcachedAddrPort 127.0.0.1:11211
    # minimal connections that will be opened to memcached. Default is 0
    ZrkadloMemcachedConnMin 16
    # soft maximum of connections that will be opened to memcached. Default is 1
    ZrkadloMemcachedConnSoftMax 64
    # hard maximum of connections that will be opened to memcached. Default is the value of ThreadLimit.
    #ZrkadloMemcachedConnHardMax 64
    # lifetime of objects in memcache daemon
    ZrkadloMemcachedLifetime 600

    # configure libGeoIP
    ZrkadloGeoIPFile /usr/share/GeoIP/GeoIP.dat

    # treat clients from country "nz" as if they were in country "au"
    ZrkadloTreatCountryAs nz au

    # Available details for logging with the CustomLog directive:
    # %{Location}o                the full redirection URL
    # %{X-Zrkadlo-Chose-Mirror}o  the mirror identifier
    # %{ZRKADLO_FILESIZE}e        the size of the file
    # %{ZRKADLO_REDIRECTED}e      '1' if the request was redirected
    # %{ZRKADLO_NOMIRROR}e        '1' if no mirror was found
    # The following two are not always set, because, for performance reasons,
    # mod_zrkadlo doesn't do a geoip lookup for every request, but only
    # when needed. For instance, if files are excluded from redirection,
    # the lookup will not be reached in the codepath.
    # %{ZRKADLO_CONTINENT_CODE}e  the client's continent code
    # %{ZRKADLO_COUNTRY_CODE}e    the client's country code

    # Log where we redirected to, through the the %{Location}o logging variable
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{Location}o\"" zrkadlo
    CustomLog "|/usr/sbin/rotatelogs2 /var/log/apache2/redirects_%Y-%m-%d-%H 3600 -0" zrkadlo

    # Or, write an extra file logging _only_ redirections. mod_zrkadlo sets the
    # environment variable ZRKADLO_REDIRECTED to 1 whenever it redirects a client.
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{Location}o\"" redirected
    CustomLog /var/log/apache2/redirected_log redirected env=ZRKADLO_REDIRECTED


    # Whenever no mirror is found for a file, mod_zrkadlo sets the enviroment
    # variable ZRKADLO_NOMIRROR. This can be used to write an additional file
    # logging all unmirrored files, including the bytes we served ourselves:
    LogFormat "%h %t %U %B \"%{Referer}i\"" nomirror
    CustomLog /var/log/apache2/unmirrored_log nomirror env=ZRKADLO_NOMIRROR

    # Example of detailed access log (also uses mod_logio to log actual sent bytes):
    <IfModule mod_logio.c>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %{X-Zrkadlo-Chose-Mirror}o %I %O %{ZRKADLO_CONTINENT_CODE}e:%{ZRKADLO_COUNTRY_CODE}e size:%{ZRKADLO_FILESIZE}e" combinedio_redirect
    </IfModule>



    # The SQL query string
    # Caveat: the fields are accessed by index. Thus, the order here must not change.
    ZrkadloDBDQuery "\
    SELECT file_server.serverid, server.identifier, server.country, server.region, server.score, server.baseurl, \
           server.country_only, server.region_only \
    FROM file_server \
    LEFT JOIN server \
    ON file_server.serverid = server.id \
    WHERE file_server.path_md5=%s AND server.enabled=1 AND server.status_baseurl=1 AND server.score > 0"


    <Directory /srv/www/htdocs/base_dir>
        # create directory listings
        Options +Indexes

        # redirector is enabled for this subtree
        # the directory where this is done matters, because it will be the basedir.
        ZrkadloEngine On

        # enable debug mode -- warning, on a busy server this should be done for subtrees
        # only, because it creates a lot of output
        ZrkadloDebug Off

        # If FormGET is "On", the module understands optional query arguments
        # (appended to the URL) for diagnostic or other uses. 
        #
        # fakefile                  pretend that the requested file exists (useful for testing)
        # newmirror                 don't stick to memcached mirror, make a new choice
        # mirrorlist                don't redirect, but send a HTML list of all mirrors
        # metalink                  don't redirect, but send a metalink (http://metalinker.org)
        # clientip=111.222.333.444  pretend that the request comes from this IP
        #
        FormGET On

        #Set to On/Off to handle HEAD requests locally (don't redirect)
        ZrkadloHandleHEADRequestLocally Off

        # Don't redirect for files smaller than 4096 bytes
        ZrkadloMinSize 4096

        # Set to On/Off to handle directory listings locally (don't redirect)
        ZrkadloHandleDirectoryIndexLocally On

        # User-Agent to always exclude from redirecting (wildcards allowed)
        ZrkadloExcludeUserAgent w3m/0.5.1

        # Network to always exclude from redirecting (simple string prefix comparison)
        ZrkadloExcludeNetwork 192.168.

        # IP address to always exclude from redirecting
        ZrkadloExcludeNetwork 10.10.10.1

        # Mimetype to always exclude from redirecting (wildcards allowed)
        ZrkadloExcludeMimeType text/xml

        # Regexp which determines which files will be excluded form redirecting
        ZrkadloExcludeFileMask "\.(xml|xml\.gz|xml\.asc)"
    </Directory>

    <Directory /srv/www/htdocs/base_dir/some_other_dir>
        Options +Indexes
        ZrkadloEngine Off
    </Directory>

    <Directory /srv/www/htdocs/base_dir/some_subdir>
        ZrkadloDebug On
    </Directory>

</IfModule>

# vim: set ft=apache ts=4 sw=4 ai expandtab smarttab:
