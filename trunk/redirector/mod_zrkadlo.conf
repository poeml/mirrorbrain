
<IfModule mod_zrkadlo.c>

    # configure memcache daemon(s)
    ZrkadloMemcachedAddrPort 127.0.0.1:11211
    # minimal connections that will be opened to memcached. Default is 0
    ZrkadloMemcachedConnMin 16
    # soft maximum of connections that will be opened to memcached. Default is 1
    ZrkadloMemcachedConnSoftMax 64
    # hard maximum of connections that will be opened to memcached. Default is the value of ThreadLimit.
    #ZrkadloMemcachedConnHardMax 64
    # lifetime of objects in memcache daemon
    ZrkadloMemcachedLifetime 600

    # configure libGeoIP
    ZrkadloGeoIPFile /usr/share/GeoIP/GeoIP.dat

    # treat country "nz" as country "au"
    ZrkadloTreatCountryAs nz au

    # In order to be able to parse which mirrors are getting which data we use
    # the %{Location}o logging variable
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{Location}o\"" zrkadlo
    CustomLog "|/usr/sbin/rotatelogs2 /var/log/apache2/redirects_%Y-%m-%d-%H 3600 -0" zrkadlo

    # The SQL query string
    ZrkadloDBDQuery "\
    SELECT file_server.serverid, server.identifier, server.country, server.region, server.score, server.baseurl \
    FROM file \
    LEFT JOIN file_server \
    ON file.id = file_server.fileid \
    LEFT JOIN server \
    ON file_server.serverid = server.id \
    WHERE file.path=%s AND server.enabled=1 AND server.status_baseurl=1 AND server.score > 0"


    <Directory /srv/www/htdocs/base_dir>
        # create directory listings
        Options +Indexes

        # redirector is enabled for this subtree
        # the directory where this is done matters, because it will be the basedir.
        ZrkadloEngine On

        # enable debug mode -- warning, on a busy server this should be done for subtrees
        # only, because it creates a lot of output
        ZrkadloDebug Off

        # parse optional URL query string, which can be:
        # fakefile                  pretend that the requested file exists (useful for testing)
        # newmirror                 don't stick go memcached mirror, make a new choice
        # clientip=111.222.333.444  pretend that the request comes from this IP
        FormGET On

        #Set to On/Off to handle HEAD requests locally (don't redirect)
        ZrkadloHandleHEADRequestLocally Off

        # Don't redirect for files smaller than 4096 bytes
        ZrkadloMinSize 4096

        # Set to On/Off to handle directory listings locally (don't redirect)
        ZrkadloHandleDirectoryIndexLocally On

        # User-Agent to always exclude from redirecting (wildcards allowed)
        ZrkadloExcludeUserAgent w3m/0.5.1

        # Mimetype to always exclude from redirecting (wildcards allowed)
        ZrkadloExcludeMimeType text/xml

        # Regexp which determines which files will be excluded form redirecting
        ZrkadloExcludeFileMask "\.(xml|xml\.gz|xml\.asc)"
    </Directory>

    <Directory /srv/www/htdocs/base_dir/some_other_dir>
        Options +Indexes
        ZrkadloEngine Off
    </Directory>

    <Directory /srv/www/htdocs/base_dir/some_subdir>
        ZrkadloDebug On
    </Directory>

</IfModule>

# vim: set ft=apache ts=4 sw=4 ai expandtab smarttab:
